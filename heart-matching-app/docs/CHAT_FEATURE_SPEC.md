# 患者詳細画面・チャット機能 仕様書

## 概要

フリマアプリライクな患者詳細画面とリアルタイムチャット機能を実装し、マッチング前の施設間コミュニケーションを効率化する。

## 背景・目的

### 現在の課題
- 患者情報の詳細が一覧で見づらい
- マッチング前の事前相談が電話・FAXのみ
- 施設間の情報交換が非効率
- マッチング可否の判断に時間がかかる

### 解決したいこと
- 詳細情報の視覚的な確認
- 24時間対応可能な非同期コミュニケーション
- 医療資料の迅速な共有
- マッチング精度の向上

## 機能仕様

### 1. 患者詳細画面

#### 1.1 画面遷移
```
患者一覧 → 患者カードクリック → 患者詳細画面
```

#### 1.2 表示内容
**基本情報セクション**
- 患者ID（匿名）
- 年齢層・性別
- 診断名・NYHA分類
- 介護度・ADL状況

**医療情報セクション**
- 現在の医療処置
- 必要な医療機器
- 服薬情報
- アレルギー・禁忌事項

**希望サービスセクション**
- 希望するサービス種別
- 介入希望頻度
- 介入可能日時
- 特別な要望

**地域・アクセス情報**
- 対応エリア
- 交通アクセス
- 駐車場情報

**登録施設情報**
- 登録施設名
- 登録日
- 連絡先情報

#### 1.3 アクション
- 「相談する」ボタン → チャット画面へ遷移
- 「直接連絡」ボタン → 従来の連絡先モーダル表示
- 「戻る」ボタン → 患者一覧へ戻る

### 2. チャット機能

#### 2.1 チャット画面UI
**フリマアプリ風デザイン**
- 画面上部：患者ID・基本情報の要約
- 中央エリア：メッセージ履歴
- 下部：メッセージ入力エリア
- サイドバー：患者詳細情報（折りたたみ可能）

#### 2.2 メッセージ機能
**基本メッセージ**
- テキストメッセージ送受信
- タイムスタンプ表示
- 既読・未読ステータス
- 送信者識別（施設名表示）

**ファイル共有**
- 画像ファイル共有（検査結果、レントゲン等）
- PDFファイル共有（紹介状、サマリー等）
- ファイルサイズ制限：10MB以下
- 対応形式：JPG, PNG, PDF

**定型メッセージ**
- よく使用される質問の定型文
- 「受け入れ可能です」「検討中です」等のクイック返信
- カスタム定型メッセージの作成・保存

#### 2.3 通知機能
- 新着メッセージのリアルタイム通知
- ブラウザ通知（許可時）
- 未読件数のバッジ表示
- メール通知（オプション）

### 3. マッチング進行管理

#### 3.1 ステータス管理
```
1. 照会申請 → 2. 相談中 → 3. マッチング成立 → 4. 連携完了
```

**各ステータスの定義**
- **照会申請**: 初回相談メッセージ送信時
- **相談中**: 双方向でメッセージ交換中
- **マッチング成立**: 受け入れ施設が正式承諾
- **連携完了**: 患者移行・サービス開始完了

#### 3.2 ステータス変更アクション
- 「受け入れ承諾」ボタン → マッチング成立
- 「お断り」ボタン → 相談終了
- 「連携完了」ボタン → 完了ステータス

### 4. 外部システム連携

#### 4.1 MCS（Medical Care Station）連携
**マッチング成立後の流れ**
```
マッチング成立 → MCS連携確認 → 患者情報引き継ぎ → MCSでの継続管理
```

**連携内容**
- 基本的な患者情報の引き継ぎ
- チャット履歴の要約作成
- MCSへのリンク・誘導
- 既存ワークフローとの統合

## 技術仕様

### 4.1 フロントエンド
**使用技術**
- React + TypeScript
- TailwindCSS（UIコンポーネント）
- Socket.io-client（リアルタイム通信）
- React Router（画面遷移）

**主要コンポーネント**
```
- PatientDetailView
- ChatInterface
- MessageList
- MessageInput
- FileUpload
- StatusIndicator
```

### 4.2 バックエンド（将来実装）
**API設計**
```
GET /api/patients/:id - 患者詳細取得
GET /api/chats/:patientId - チャット履歴取得
POST /api/chats/:patientId/messages - メッセージ送信
POST /api/chats/:patientId/files - ファイルアップロード
PATCH /api/matching/:id/status - マッチングステータス更新
```

**WebSocket通信**
```
- 新着メッセージのリアルタイム配信
- 既読ステータスの同期
- ステータス変更の通知
```

### 4.3 データ構造
**チャットメッセージ**
```javascript
{
  id: "msg_123",
  chatId: "chat_456",
  senderId: "facility_789",
  senderName: "○○クリニック",
  message: "こちらの患者様について相談があります",
  messageType: "text", // text, image, file
  fileUrl: "https://...", // ファイルの場合
  timestamp: "2024-07-01T10:30:00Z",
  isRead: false
}
```

**マッチングステータス**
```javascript
{
  id: "matching_123",
  patientId: "HF-ABC123",
  requestingFacility: "○○病院",
  respondingFacility: "△△在宅クリニック",
  status: "consulting", // requesting, consulting, matched, completed, declined
  createdAt: "2024-07-01T09:00:00Z",
  updatedAt: "2024-07-01T10:30:00Z"
}
```

## UI/UX設計

### 5.1 患者詳細画面レイアウト
```
┌─────────────────────────────────────┐
│ ← 戻る    患者ID: HF-ABC123        │
├─────────────────────────────────────┤
│ [基本情報]                          │
│ 70代男性・慢性心不全・NYHA Ⅱ        │
│                                     │
│ [医療情報]                          │
│ 在宅酸素・服薬管理・心リハ          │
│                                     │
│ [希望サービス]                      │
│ 訪問診療（週1-2回）                 │
│                                     │
│ [アクション]                        │
│ [相談する] [直接連絡]               │
└─────────────────────────────────────┘
```

### 5.2 チャット画面レイアウト
```
┌─────────────────────────────────────┐
│ ← 戻る  患者: HF-ABC123  [詳細▼]   │
├─────────────────────────────────────┤
│                                     │
│  ○○病院 10:30                      │
│  この患者様の受け入れは可能でしょうか│
│                                     │
│                     △△クリニック 10:35│
│             詳細を確認いたします    │
│                                     │
│  ○○病院 10:40                      │
│  [検査結果.pdf]                    │
│                                     │
├─────────────────────────────────────┤
│ [📎] [メッセージを入力...] [送信]   │
└─────────────────────────────────────┘
```

## 実装フェーズ

### フェーズ1: 基本的な詳細画面（2週間）
- 患者詳細画面の実装
- 基本情報の表示
- 画面遷移の実装

### フェーズ2: チャット機能（3週間）
- チャットUIの実装
- メッセージ送受信機能
- ローカルストレージでの履歴保存

### フェーズ3: ファイル共有・通知（2週間）
- ファイルアップロード機能
- 通知システム
- 定型メッセージ

### フェーズ4: マッチング管理（2週間）
- ステータス管理機能
- マッチングフローの実装
- 外部システム連携準備

### フェーズ5: 最適化・バックエンド連携（3週間）
- リアルタイム通信の実装
- API連携
- パフォーマンス最適化

## 成功指標

### 利用指標
- チャット機能利用率: >75%
- メッセージ返信率: >80%
- ファイル共有成功率: >95%
- 詳細画面閲覧率: >90%

### 効率指標
- マッチング成立までの時間短縮: 50%削減
- 事前相談による適切な照会率: >85%
- 照会取り消し率の削減: 30%削減

### 満足度指標
- ユーザー満足度: >4.0/5.0
- 「使いやすい」評価: >80%
- 継続利用意向: >85%

---

**作成日**: 2025年6月28日  
**更新日**: 2025年6月28日  
**作成者**: 開発チーム  
**レビュー予定**: 週次レビュー時
